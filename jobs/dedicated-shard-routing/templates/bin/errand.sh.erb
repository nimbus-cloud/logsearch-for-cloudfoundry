#!/bin/bash

set -e

<%
  elasticsearch_host = nil
  elasticsearch_port = nil
  if_link("elasticsearch") { |elasticsearch_link|
    elasticsearch_host = elasticsearch_link.instances.first.address
    elasticsearch_port = elasticsearch_link.p("elasticsearch.port")
  }
  unless elasticsearch_host
    elasticsearch_host = p("dedicated-shard-routing.elasticsearch.host")
    elasticsearch_port = p("dedicated-shard-routing.elasticsearch.port")
  end
%>

curl -s \
    -X PUT \
    -d '{"index.routing.allocation.exclude.name" : "es_data_*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/logs-app-20*/_settings'
echo ": index routing for all"

curl -s \
    -X PUT \
    -d '{"order": 1,"settings": {"index": {"routing": {"allocation": {"exclude": {"name": "es_data_*"},"require": {"name": "elasticsearch_data*"}}}}},"template": "<%= p('dedicated-shard-routing.index_prefix') %>-20*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/_template/template_all-orgs'
echo ": index template for all"

<% p('dedicated-shard-routing.dedicated_cf_orgs').each do | org | %>
curl -s \
    -X PUT \
    -d '{"order": 1,"settings": {"index": {"routing": {"allocation": {"exclude": {"name": "elasticsearch_data*"},"require": {"name": "es_data_<%= org.downcase %>*"}}}}},"template": "<%= p('dedicated-shard-routing.index_prefix') %>-<%= org.downcase %>-*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/_template/template_<%= org.downcase %>'
echo ": index template for <%= org.downcase %>"

curl -s \
    -X PUT \
    -d '{"index.routing.allocation.exclude.name" : "elasticsearch_data*", "index.routing.allocation.require.name" : "es_data_<%= org.downcase %>*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/<%= p('dedicated-shard-routing.index_prefix') %>-<%= org.downcase %>-*/_settings'
echo ": index routing for <%= org.downcase %>"

<% end %>