#!/bin/bash

set -e

<%
  elasticsearch_host = nil
  elasticsearch_port = nil
  if_link("elasticsearch") { |elasticsearch_link|
    elasticsearch_host = elasticsearch_link.instances.first.address
    elasticsearch_port = elasticsearch_link.p("elasticsearch.port")
  }
  unless elasticsearch_host
    elasticsearch_host = p("dedicated_shard_routing.elasticsearch.host")
    elasticsearch_port = p("dedicated_shard_routing.elasticsearch.port")
  end
%>

curl -s \
    -X PUT \
    -H 'Content-Type: application/json' \
    -d '{"index.routing.allocation.exclude.name" : "es_data_*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/<%= p('dedicated_shard_routing.index_prefix') %>-20*/_settings'
echo ": index routing for all"

curl -s \
    -X PUT \
    -H 'Content-Type: application/json' \
    -d '{"order": 1,"settings": {"number_of_shards": 1, "index": {"routing": {"allocation": {"exclude": {"name": "es_data_*"},"require": {"name": "elasticsearch_data*"}}}}},"template": "<%= p('dedicated_shard_routing.index_prefix') %>-20*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/_template/template_all-orgs'
echo ": index template for all"

<% p('dedicated_shard_routing.dedicated_cf_orgs').each do | org, shards | %>
curl -s \
    -X PUT \
    -H 'Content-Type: application/json' \
    -d '{"order": 1,"settings": {"index": {"number_of_shards": <%= shards %>, "routing": {"allocation": {"exclude": {"name": "elasticsearch_data*"},"require": {"name": "es_data_<%= org.downcase %>*"}}}}},"template": "<%= p('dedicated_shard_routing.index_prefix') %>-<%= org.downcase %>-*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/_template/template_<%= org.downcase %>'
echo ": index template for <%= org.downcase %>"

curl -s \
    -X PUT \
    -H 'Content-Type: application/json' \
    -d '{"index.routing.allocation.exclude.name" : "elasticsearch_data*", "index.routing.allocation.require.name" : "es_data_<%= org.downcase %>*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/<%= p('dedicated_shard_routing.index_prefix') %>-<%= org.downcase %>-*/_settings'
echo ": index routing for <%= org.downcase %>"

<% end %>

<% if properties.dedicated_shard_routing.platform_logs == true %>
curl -s \
    -X PUT \
    -H 'Content-Type: application/json' \
    -d '{"index.routing.allocation.exclude.name": "es_data_*","index.routing.allocation.require.name": "elasticsearch_platform*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/<%= p('dedicated_shard_routing.platform_index_prefix') %>*/_settings'
echo ": index routing for paltfrom logs"

curl -s \
    -X PUT \
    -H 'Content-Type: application/json' \
    -d '{"order": 1,"settings": {"index": {"routing": {"allocation": {"exclude": {"name": "es_data_*","name": "elasticsearch_data*"},"require": {"name": "elasticsearch_platform*"}}}}},"template": "<%= p('dedicated_shard_routing.platform_index_prefix') %>*"}' \
    '<%= elasticsearch_host %>:<%= elasticsearch_port %>/_template/template_platform'
echo ": index template for platfrom logs"
<% end %>